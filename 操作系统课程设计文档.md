
# 操作系统课程设计文档

#### 小组成员

+ 1352868 胡昊南 1班（430）
+ 1352840 李平山 2班（416）

#### 项目目的

+ 通过参考、修改源码模块，实现自己的OS，加深对系统底层的认识
+ 理解汇编语言与底层硬件的交互

#### 开发环境
+ 操作系统：Ubuntu 14.04
+ 虚拟机：Bochs
+ 编辑器：Vim
+ 编译器：GCC

#### 任务描述

+ 修改或者重新实现参考源码的一个或多个模块

#### 系统界面
![OS][1]

#### 实现细节

+ 重构

```
    int alloc_imap_bit(int dev)//为新文件分配位置
    
    int alloc_smap_bit(int dev,int nr_sects_to_alloc)//为文件内容分配扇区空间
```
将上述两个函数重构为:
```
    int alloc_ismap_bit(int dev,int nr_sects_to_alloc)
```
由于上述两个函数有较多重复之处，故重构，以减少重复代码。
在新函数中，将<code>nr_sects_to_alloc</code>赋值为0,实现原<code>alloc_imap_bit</code>的功能。。。。。。

+ 实现MESSAGE收发

```
    PUBLIC int myfsmsg()
    {
    	MESSAGE msg;
    
    	msg.type	= MYFSMSG;
    
    	send_recv(BOTH, TASK_FS, &msg);
    	assert(msg.type == SYSCALL_RET);
    
    	return msg.FD;
    }
```
+ 输出磁盘信息

获取<code>hdinfo</code>数组，根据<a href="http://read.pudn.com/downloads97/ebook/399380/ata_atapi-6.pdf" target="_blank">ATAPI-6文档（P115）</a>，分别取出<code>hdinfo</code>数组多个元素；其中，元素为十六进制，每一位（0或1）表示不同的属性，需要通过与运算（&），提取各位的值，判断0或1，据此来判断磁盘特性，并打印输出至显示屏。示例如下：
```
	int capabilities = hdinfo[49];

	printl("Timer values supported: %s\n",(capabilities & 0x2000) ? "Yes" : "No");
```
+ 修改屏幕滚动机制

源代码中，屏幕由<code>SHIFT + UP/DOWN</code>来控制屏幕信息的滚动，但是在修改中发现，如果屏幕打印信息超过一定行数时，较早打印的信息将会被清空；通过直接修改代码中<code>SCR_SIZE</code>的值，使屏幕能够容纳更多的信息，而不用担心被清空。

  [1]: ./images/whole.png "whole.png"
